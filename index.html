<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>US Map with Bubbles</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <!-- Include D3.js library -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>

<body>
  <div class="container">
    <div class="col-lg-12 mt-4">
      <div class="filters my-4">
        <label for="departmentDropdown">Department:</label>
        <select id="departmentDropdown"></select>

        <label for="employmentTypeDropdown">Employment Type:</label>
        <select id="employmentTypeDropdown"></select>
      </div>

      <div id="mapContainer"></div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
  <!-- Step 1. Load D3 and topoJSON libraries -->
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <!-- Include your JavaScript file -->
  <script src="newscript.js"></script>

  <script>
    (async () => {
      // Step 2. Load the US map data.
      const us = await d3.json("https://d3js.org/us-10m.v2.json");
      const data = topojson.feature(us, us.objects.states).features;

      // Step 3. Draw the SVG.
      // First let's create an empty SVG with 960px width and 600px height.
      const width = 960;
      const height = 600;
      const svg = d3
        .select("#mapContainer")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

      // Create an instance of geoPath.
      const path = d3.geoPath();

      // Use the path to plot the US map based on the geometry data.
      svg
        .append("g")
        .selectAll("path")
        .data(data)
        .enter()
        .append("path")
        .attr("d", path)
        .attr("id", (d) => d.properties.name.replace(/\s/g, "")).style("fill", "lightgray").style("stroke", "black") // Border color
        .style("stroke-width", 1); // Border width;

      // Add text for state initials
      svg
        .selectAll("text")
        .data(data)
        .enter()
        .append("text")
        .attr("x", (d) => path.centroid(d)[0])
        .attr("y", (d) => path.centroid(d)[1])
        .text((d) => d.properties.name.substring(0, 2));

      // Step 4. Add filters for department, employment type, and skill
      const departments = await d3.json("http://localhost:3000/departments");
      const employmentTypes = await d3.json("http://localhost:3000/employmenttypes");

      d3.select("#departmentDropdown")
        .append("option")
        .attr("value", "")
        .text("Select");

      // Append department options
      d3.select("#departmentDropdown")
        .selectAll("option:not(:first-child)")
        .data(departments)
        .enter()
        .append("option")
        .attr("value", (d) => d)
        .text((d) => d);

      // Add an empty option as the default (not selected) state
      d3.select("#employmentTypeDropdown")
        .append("option")
        .attr("value", "")
        .text("Select");

      // Append employment type options
      d3.select("#employmentTypeDropdown")
        .selectAll("option:not(:first-child)")
        .data(employmentTypes)
        .enter()
        .append("option")
        .attr("value", (d) => d)
        .text((d) => d);

      // Step 5. Populating circles based on the count of employment type in each state
      const jobsData = await d3.json("http://localhost:3000/jobs/groupedEmploymentType");

      svg
        .append("g")
        .attr("class", "bubble")
        .selectAll("circle")
        .data(topojson.feature(us, us.objects.states).features)
        .enter()
        .append("circle")
        .attr("transform", function (d) {
          return "translate(" + path.centroid(d) + ")";
        })
        .attr("r", (d) => {
          // Find the corresponding data point for the current state based on state abbreviation
          const stateData = jobsData.find((job) => job._id.state === d.properties.name.replace(/\s/g, ""));

          // Use square root of count for balanced radius
          return stateData ? Math.sqrt(stateData.count) * 2 : 0; // Set radius to 0 if no data for the state
        });
    })();
  </script>
</body>

</html>